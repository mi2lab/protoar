<html>

<head>
    <!-- auto redirect to https
         Source: http://stackoverflow.com/questions/4723213/detect-http-or-https-then-force-https-in-javascript -->
    <script type="text/javascript">
        if (location.protocol != 'https:') {
            location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        }
    </script>

    <title>ProtoAR Mock</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta id="theme-color" name="theme-color" content="#000000">

    <style>
        html,
        body {
            width: 100%;
            height: 100%;
        }
        
        body {
            margin: 0px;
            padding: 0px;
            overflow: hidden;
            background: black;
        }
        
        video,
        canvas {
            position: absolute;
            left: 0px;
            top: 0px;
            width: 640px;
            height: 480px;
        }
        
        canvas {
            opacity: 0.8;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    <script type="text/javascript" src="../.common/webRTC.js"></script>
    <script type="text/javascript" src="../.common/camera.js"></script>
</head>

<body>
    <video></video>
    <canvas></canvas>
    <script>
        var broadcaster = location.search === "?id=broadcaster";

        var w = 640,
            h = 480;

        var rearVideo = document.querySelector("video");

        var rearCamera = new Camera({
            camera: -1,
            video: rearVideo,
            videoWidth: w,
            videoHeight: h
        });

        var frontCamera = new Camera({
            camera: 0,
            videoWidth: w,
            videoHeight: h,
            autostart: false
        });

        var frontCanvas = document.querySelector("canvas"),
            frontContext = frontCanvas.getContext("2d");

        var socket = io();

        socket.on("connect", function () {
            socket.emit("room", "protoar");
        });

        var c = document.createElement("canvas"),
            ctx = c.getContext("2d");

        frontCanvas.width = w;
        frontCanvas.height = h;

        c.width = w;
        c.height = h;

        if (broadcaster) {
            frontCamera.onstart = function () {
                WebRTC.init("broadcaster", {
                    socket: socket,
                    stream: frontCamera.stream
                });
            }

            frontCamera.start();
        }
        else {
            WebRTC.init("receiver", {
                socket: socket,
                video: frontCamera.video
            });
        }

        setInterval(function () {
            ctx.drawImage(frontCamera.video, 0, 0);

            var frontImage = ctx.getImageData(0, 0, w, h),
                frontBitmap = frontImage.data;

            // Merge the bitmaps
            for (var i = 0, n = frontBitmap.length; i < n; i += 4) {
                var r = frontBitmap[i],
                    g = frontBitmap[i + 1],
                    b = frontBitmap[i + 2],
                    threshold = 31;

                // Only leave super dark pixels (we're looking for mocks in black ink)
                if (r >= threshold && g >= threshold && b >= threshold) {
                    frontBitmap[i] = 0;
                    frontBitmap[i + 1] = 0;
                    frontBitmap[i + 2] = 0;
                    frontBitmap[i + 3] = 0;
                }
            }

            frontContext.putImageData(frontImage, 0, 0);

            if (!broadcaster && window.innerWidth < window.innerHeight) {
                alert("Rotate to landscape!");
            }
        }, 10);
    </script>
</body>

</html>
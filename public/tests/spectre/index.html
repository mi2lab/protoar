<html>

<head>

	<title>Spectre</title>

	<meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
	<meta name="mobile-web-app-capable" content="yes">
	<meta id="theme-color" name="theme-color" content="#000000">


	<style>
		html,
		body {
			height: 100%;
		}
		
		body {
			background: black;
			overflow: hidden;
		}
		
		#container {
			width: 100%;
			height: 100%;
		}
		
		#hologram {
			position: absolute;
			width: 200px;
			height: 200px;
			overflow: hidden;
			color: white;
			text-align: center;
			font-size: 10px;
		}
		
		.fishbowl {
			border-top: 3px solid blue;
			position: relative;
			top: -175px;
			height: 100px;
			width: 200px;
			opacity: 0.4;
			z-index: 999
		}
	</style>

	<script src="/.common/require.js"></script>

</head>

<body>
	<div id="container">
		<!-- Text and Image -->
		<!--
        <div id="hologram">
            <h1>Text</h1>
            <img height="30" src="../../mi2lab_logo_transparent.png">
        </div>
-->
		<!-- Video -->

		<div id="hologram">
			<!--<video muted loop src="roesti.mp4" width="200" height="200"></video>-->
			<video muted loop src="goldfish.mp4" width="200" height="200"></video>
			<div class="fishbowl"></div>
		</div>

		<!-- Stream -->
		<!--
        <div id="hologram">
            <video autoplay width="200" height="200"></video>
        </div>
-->
	</div>

	<script>
		// toggle fullscreen
		(function () {
			var doc = window.document;
			var docEl = doc.documentElement;

			var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
			var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

			if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
				requestFullScreen.call(docEl);
			}
			else {
				cancelFullScreen.call(doc);
			}
		})();

		require(["jquery", "webrtc", "device"]).then(function () {
			var videoReady = 0;
			$("video").on("loadeddata", function () {
				console.log(++videoReady);

				if (videoReady == $("video").length) {
					console.log("all ready!");
					$("video").each(function () {
						this.currentTime = 0;
						this.play();
					});
				}
			});

			var timeout;

			(function resize() {
				timeout = (function (timeout) {
					if (timeout) {
						clearTimeout(timeout);
					}
					return setTimeout(buildHolograms, 500);
				})(timeout);

				window.onresize = resize;
			})();

			var top, bottom, left, right;

			function buildHolograms() {
				$(".hologram-clone").detach();
				$("video").each(function () {
					this.pause();
				});
				videoReady = 1;

				var mx = window.innerWidth / 2,
					my = window.innerHeight / 2,
					hw = $("#hologram").width(),
					hh = $("#hologram").height(),
					padding = 55;

				// top
				top = $("#hologram").css({
					//background: "blue",
					left: mx - hw / 2,
					top: my - hh - padding
				});

				// bottom
				bottom = $("#hologram").clone(true).css({
					//background: "red",
					left: mx - hw / 2,
					top: my + padding,
				}).addClass("hologram-clone").appendTo("#container");

				// left
				left = $("#hologram").clone(true).css({
					//background: "yellow",
					left: mx - hw - padding,
					top: my - hh / 2,
				}).addClass("hologram-clone").appendTo("#container");

				// right
				right = $("#hologram").clone(true).css({
					//background: "green",
					left: mx + padding,
					top: my - hh / 2,
				}).addClass("hologram-clone").appendTo("#container");

			}

			Device.orientationHandler = function updateHolograms() {
				requestAnimationFrame(updateHolograms);
				var deg = Device.orientation.getXDeg();

				// top
				top.css({
					transform: "rotate(" + (deg + 0) + "deg) scale(-1, 1)"
				});

				// bottom
				bottom.css({
					transform: "rotate(" + (deg + 180) + "deg) scale(-1, 1)"
				});

				// left
				left.css({
					transform: "rotate(" + (deg - 90) + "deg)"
				});

				// right
				right.css({
					transform: "rotate(" + (deg + 90) + "deg) scale(-1, 1)"
				});
			}

			new WebRTC({
				room: "room3356",
				onstream: function (stream) {
					console.log(stream);
					$("video").each(function () {
						this.srcObject = stream;
					})
				}
			});
		});
	</script>

</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ProtoAR Cardboard Viewer</title>
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>

    <script src="/.common/https.js"></script>
    <script src="/.common/require.js"></script>

    <style>
        #debug {
            position: absolute;
            left: 0px;
            bottom: 0px;
            height: 10%;
            overflow: hidden;
            z-index: 9999;
            font-family: monospace;
            font-size: 200%;
            color: white;
        }
    </style>
</head>

<body>
    <div id="debug"></div>
    <a-scene style="opacity: 0.5">
        <a-assets>
            <video id="video" autoplay loop crossorigin></video>
        </a-assets>

        <a-box id="redbox" click-drag position="0 0 -5" dynamic-body="mass: 0.1" color="red"></a-box>
        <a-box id="bluebox" click-drag position="5 0 -5" dynamic-body="mass: 0.1" color="blue"></a-box>

        <a-sky src="#video" radious="0"></a-sky>

        <a-camera id="camera" look-controls-enabled="true"></a-camera>
    </a-scene>
    <script>
        var video = document.querySelector("#video");
        var scene = document.querySelector("a-scene");
        var camera = scene.querySelector("a-camera");

        var timeout;
        (function resize() {
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                if (window.innerWidth > window.innerHeight) {
                    video.style.width = "100%";
                    video.style.height = "auto";
                }
                if (video.clientHeight < window.innerHeight) {
                    video.style.width = "auto";
                    video.style.height = "100%";
                }
            }, 500);
            window.onresize = resize;
        })();

        var vars = {};

        function debug(name, value) {
            vars[name] = value;
            document.querySelector("#debug").innerHTML = JSON.stringify(vars);
        }

        require(["webrtc", "camera", "xd"]).then(function () {
            XD.log = console.log;

            function setVideo(stream) {
                if (!video.srcObject) video.srcObject = stream;
            }

            var webrtc = new WebRTC({
                room: "protoar",
                //onstream: setVideo
            });

            new Camera({
                camera: 0,
                onstream: function (stream) {
                    setVideo(stream);
                    webrtc.addStream(stream);
                }
            });
        });
    </script>
</body>

</html>